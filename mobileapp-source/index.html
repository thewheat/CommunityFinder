<html> 
<head> 
	<title>CommunityFinder.net</title> 
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<link rel="stylesheet" type="text/css" href="css/index.css" />
	
	<!-- jquery mobile - 1 -->
	<link rel="stylesheet"  href="css/jqm_themes/default/jquery.mobile-1.2.0.css" />
	<script src="js/jquery-1.8.3.min.js"></script>
	<script src="js/jquery.mobile-1.2.0.min.js"></script>
	<!-- jquery mobile - 0 -->

	<!-- jquery maps - 1 -->
	<script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<script src="js/jquery.ui.map.min.js"></script>
	<script src="js/jquery.ui.map.extensions.js"></script>
	<script src="js/jquery.ui.map.services.min.js"></script>
	<!-- jquery maps - 0 -->
	
	<!-- phonegap - 1 -->
	<script type="text/javascript" src="cordova-2.2.0.js"></script>
	<script type="text/javascript" src="js/index.js"></script>
	<script type="text/javascript">
		app.initialize();
	</script>
	<!-- phonegap - 0 -->
	<style type="text/css">
		.template { display: none;}
	</style>
<script>
	/////////////////////////////////////////////
	// to add
	/////////////////////////////////////////////
	//	   	soon
	//			what details to display in result listing & marker infoWindow when clicked
	//			need to show what search term is matched (e.g. on default map load search "ab". Borderlands Cooperative shows. But the title doesn't match "ab" search)
	//			
	//   		closing infoWindow before refresh markers (currently stays open if refresh search)
	//
	//		later
	//   		dialog box when clicking marker 
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-geocoding.html
	//   		pagination of items when clicking a marker: 
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-extend-with-pagination.html
	//			micro data page view  
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-microdata.html
	/////////////////////////////////////////////
	// to add
	/////////////////////////////////////////////

	//var DEFAULT_LOCATION = new google.maps.LatLng(-37.816667, 144.966667);
	var DEFAULT_LOCATION = new google.maps.LatLng(-37.790658897800206, 144.99361038208008); // http://www.yarracity.vic.gov.au/about-yarra/ | http://www.communityfinder.net/index.php?theme=undefined&zoom=14&lat=-37.790658897800206&lng=144.99361038208008&subtype=all
								
	var DEFAULT_ZOOM = 14;
	var ANONYMOUS_USER = 133;
	var MAP_ID = "#map_canvas";
	var MAP_ID_add = "#map_canvas_add";
	var MAP_SMALL_ID = "#map_canvas_small";
	var drag_timer;
	var config = {};
		config.debug = true; // to print console logs
		config.prefix = 'http://communityfinder.net/'; // for phonegap
		config.prefix = '../webapp-source/'; // for local testing when. comment out for deployment to phonegap
		
		userDataReset();

		function userDataReset(){
			config.email = "";
			config.full_name = "";
			config.username = "";
			config.user_id = 0;
		}

		// draw map centred on location. retrieve results
		function mapLocation(location){
			$(MAP_ID).gmap('option', 'center', location);
			$(MAP_ID).gmap('option', 'zoom', DEFAULT_ZOOM);
			loadMarkers(location);
		}
		
		// gecode location and do a search
		// https://developers.google.com/maps/documentation/geocoding/
		function findLocationByName(address){
			var geocoder = new google.maps.Geocoder(); // v3
			geocoder.geocode( { 'address': address}, function(results, status) { // v3
				switch (status) {
					case google.maps.GeocoderStatus.OK:
						var location = results[0];
						mapLocation(location.geometry.location);
						return;
					case google.maps.GeocoderStatus.ZERO_RESULTS:
						alert("No results found");
						return;
					case google.maps.GeocoderStatus.OVER_QUERY_LIMIT:
						alert("Too many API calls...");
						return; 
					case google.maps.GeocoderStatus.REQUEST_DENIED:
						alert("Request Denied. sensor not set?");
						return;
					case google.maps.GeocoderStatus.INVALID_REQUEST:
						alert("Invalid request. Missing search location?");
						return;
					default:
						alert("Unknown error");
						return;
				}
			});
		}
		function register(){

			var email = $("#register-email").val();
			var password = $("#register-pass").val();
			var full_name = $("#register-full-name").val();
			var username = $("#register-user").val();
		   
			if(email != '' && password != '' && full_name != '' && username != '') {
				$.post(config.prefix + 'data/register.php', {email: email, password: password, full_name: full_name, username: username}, function(data) {
					//$("#register_wait").css("display", "none");
					if($(data).find("response_state").attr("success") == 'true') {
						//if(doOnSuccess) {doOnSuccess();}	
						popupMsg("Registered");
					}
					else if($(data).find("error").attr("error_code") == 'email_exists') {
						if(doOnFailure) {doOnFailure('Sorry, this email address has already registered!');}
					}
					else if($(data).find("error").attr("error_code") == 'username_exists') {
						if(doOnFailure) {doOnFailure('Sorry, this username has already registered!');}
					}
					else if($(data).find("error").attr("error_code") == 'db_error') {
						if(doOnFailure) {doOnFailure('Sorry, there was a DB Error, please try again later.');}
					}
				});
			}
			else {
				if(doOnFailure) {doOnFailure('Sorry, you must fill in all fields to register!');}			 
			}
		}
		function doOnFailure(str)
		{
			popupMsg(str);
		}
		function doOnSuccess(str){
			popupMsg(str);
		}

		function logout(){
			$.post(config.prefix + 'data/logout.php', function(data) {
				//$("#register_wait").css("display", "none");
				if($(data).find("response_state").attr("success") == 'true') {
					userDataReset();
					//if(doOnSuccess) {doOnSuccess(that.username);}
					popupMsg("Logged out");
					openSearchPage();
					
				}
				else {
					if(doOnFailure) {doOnFailure('Could not log out');}
				}
			});
		}
		function login(){
			var email_or_username = $("#login-user").val();
			var password = $("#login-pass").val();
				 
			if(email_or_username != '' && password != '') {
				$.post(config.prefix + 'data/login.php', {email_or_username:email_or_username, password:password}, function(data) {
					//$("#register_wait").css("display", "none");
					if($(data).find("response_state").attr("success") == 'true') {
						//that.email = $(data).find("user").attr("email");
						//that.full_name = $(data).find("user").attr("full_name");
						//that.username = $(data).find("user").attr("username");
						config.email = $(data).find("user").attr("email");
						config.full_name = $(data).find("user").attr("full_name");
						config.username = $(data).find("user").attr("username");
						config.user_id = $(data).find("user").attr("user_id");
						//if(doOnSuccess) {doOnSuccess(that.username);}
						popupMsg("Logged in");
						openSearchPage();
					}
					else {
						if(doOnFailure) {doOnFailure('Incorrect username or password, please try again.');}
					}
				});
			}
			else {
				doOnFailure('You need to provide your email and password to log in.');		 
			}			
		}
		// does the search based on a location
		// calls backend API
		function loadMarkers(location){
			var map = $(MAP_ID).gmap('get', 'map'); 
			var Bounds = map.getBounds();
			var NorthEast = Bounds.getNorthEast();
			var SouthWest = Bounds.getSouthWest();
			var north_lat = NorthEast.lat();
			var east_lng = NorthEast.lng();
			var south_lat = SouthWest.lat();
			var west_lng = SouthWest.lng();	
			
			var filter_text = $("#txtSearch").val();
			var filter_subtype = $("#ddlSearch").val();
			var username = "";
			var lid = "";
			//$("#listItems").prepend("Loading items...")
			loadingMsg(true);
			if(north_lat == south_lat || east_lng == west_lng){
				north_lat += 0.05;
				south_lat -= 0.05;
				east_lng += 0.05;
				west_lng -= 0.05;
			}
			// to fix 
			// http://www.communityfinder.net/index.php?theme=undefined&zoom=14&lat=-37.790658897800206&lng=144.99361038208008&subtype=all

			/*
				JSON call
				/communityfinder/webapp-source/data/get_markers.php?
					format=json&
					north_lat=-35.59478566548724&
					east_lng=149.1119384765625&
					south_lat=-38.47079371120379&
					west_lng=142.0806884765625&
					filter_text=farm&
					filter_subtype=&
					username=&
					listing_id=					
			//*/		
			
			$.getJSON(config.prefix + 'data/get_markers.php', {format:"json",north_lat:north_lat, east_lng:east_lng, south_lat:south_lat, west_lng:west_lng, filter_text: filter_text, filter_subtype: filter_subtype, username:username, listing_id: lid /*, limit: 20 //*/ }, function(data) {
				$("#listItems").empty();
				$(MAP_ID).gmap('clear', 'markers');

				/*
				http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-data-attribute.html
				format of LI
							<li data-gmapping='{"id":"m_1","latlng":{"lat":27.6648274,"lng":-81.51575350000002},"tags":"drupal"}'>
								<p class="info-box">Florida DrupalCamp - Feb 11 2012</p>
							</li>
				*/
				
				if(!data.markers || data.markers.length == 0){
					$("#listItems").append(jQuery("<li>").html("No results found"));
				}
				else{
					for(var i = 0; i < data.markers.length; i++){
						var m = data.markers[i];
						var m_data = {id: m.lid, latlng: {lat: m.lat, lng: m.lng} };
						$("#listItems").append(jQuery("<li>").attr("data-gmapping", JSON.stringify(m_data)).html('<a class="info-box listing_link" data-parm="' + m.lid + '" href="#listing_detail" data-transition="fade">' + m.name + '</a>'));
					}
				}
				$("#listItems").listview("refresh");
				loadMarkersFromList();
				loadingMsg(false);
			});
		}

		function loadMyMarkers(){
			loadingMsg(true);
			//alert(config.user);
			//alert(config.username);
			$.getJSON(config.prefix + 'data/get_markers.php', {format:"json", username: config.username}, function(data) {
				$("#listItems").empty();
				$(MAP_ID).gmap('clear', 'markers');
				if(!data.markers || data.markers.length == 0){
					$("#listItems").append(jQuery("<li>").html("No results found"));
				}
				else{
					for(var i = 0; i < data.markers.length; i++){
						var m = data.markers[i];
						var m_data = {id: m.lid, latlng: {lat: m.lat, lng: m.lng} };
						$("#listItems").append(jQuery("<li>").attr("data-gmapping", JSON.stringify(m_data)).html('<a class="info-box listing_link" data-parm="' + m.lid + '" href="#listing_detail" data-transition="fade">' + m.name + '</a>'));
					}
				}
				$("#listItems").listview("refresh");
				loadingMsg(false);
			});
		}
		
		// load markers based on current centre (used when center is not known. e.g. on dragend)
		function loadMarkersRefresh(){
			loadMarkers($(MAP_ID).gmap('option', 'center'));
		}
		
		// reads meta-data in LI node and display on map
		// http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-data-attribute.html
		function loadMarkersFromList(){
			$("#item_summary .details").hide();
			$("[data-gmapping]").each(function(i,el) {
				var data = $(el).data('gmapping');
				$(MAP_ID).gmap('addMarker', {
						'id': data.id, 
						'tags':data.tags, 
						'position': new google.maps.LatLng(data.latlng.lat, data.latlng.lng), 
						'bounds':false  // do not snap map to fit all points
					}, function(map,marker) {
					$(el).click(function() {
						$(marker).triggerEvent('click');
					});
				}).click(function() {
					var data = $(el).find('.info-box');
					$("#item_summary .details").attr("data-parm", data.attr("data-parm")).show();
					$("#item_summary .details .ui-btn-text").text(data.text());
					 
					// $(MAP_ID).gmap('openInfoWindow', { 'content': $(el).find('.info-box').parent().html() }, this);
				});
			});		
		}

		// dragging/zooming auto refresh functions - 1
		function resetTimer(){
			clearTimeout(drag_timer);
		}
		function setTimer(time){
			resetTimer();
			drag_timer = setTimeout(function(){ 
				loadMarkers($(MAP_ID).gmap('option', 'center')); 
			}, (time ? time : 1000));
		}
		// dragging/zooming auto refresh functions - 0
		
		
		function loadCategories(){
			var restrict_subtype = '';
			$.get(config.prefix + 'data/get_subtypes.php',{restrict_subtype: restrict_subtype}, function(data) {
				$("#ddlSearch").html("");
				$("#ddlSearch").append(jQuery("<option>").attr("value", "").html("-- Any --"));
				$(data).find('icon').each(function(i) {	
					var subtype = $(this).attr('subtype');
					var type = $(this).attr('type');
					var is_addable = $(this).attr('is_addable');
					var image = $(this).attr("image");
					var subtype_name = $(this).attr("subtype_name");
					var type_name = $(this).attr("type_name");
					var prefixes = ($(this).attr("prefixes")) ? ($(this).attr("prefixes")).split(',') : null;
					var prefixes_help = $(this).attr("prefixes_help");
					$("#ddlSearch").append(jQuery("<option>").attr("value", subtype).html(subtype_name));
				});
			});
		}
		
		
			
				// Was there an error getting the Location? If so, default to google maps or default location
		function getLocationError(error){
			  		alert ('There has been a problem' + error.message);

			$(MAP_ID).gmap('getCurrentPosition', function(position, status) {
					if ( status === 'OK' ) {
						e.preventDefault();
						position = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
					}
					else
					{
						position = DEFAULT_LOCATION;
					}
					
					mapLocation(position);		  
			});
		}
		
		function getCurrentLocation(position) {
			try{
				mapLocation(position); // fails on desktop. for phonegap only?
			}catch(err){ // for desktop.
				try{
				mapLocation(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
				}
				catch(err2){
					getLocationError();
				}
			}
		}

		function loadingMsg(show){
			if(show) {
				$.mobile.loading( 'show', {
						text: 'Loading...',
						textVisible: true,
						theme: 'a',
						textonly: false,
						html: null
				});
			}
			else{
				$.mobile.loading( 'hide' );
			}
		}
		function popupMsg(msg){
			// http://jquerymobile.com/demos/1.2.0/docs/pages/popup/index.html
			// A popup div has to be nested inside the same page as the link.
			// thus can't have a global popup unless custom
			$('#popup .content').text(msg);
			$.mobile.changePage("#popup");
		}
		function openSearchPage() {
			$.mobile.changePage( "#search-page", { transition: "slide"} );
			$(MAP_ID).gmap('refresh', 1);
		}
		function openAddPage(){
			$(MAP_ID_add).gmap('clear', 'markers');
			$.mobile.changePage( "#map-page", { transition: "slide"} );
			$(MAP_ID_add).gmap('refresh', 1);
		}
		function openMapPage() {
			$.mobile.changePage( "#map-page", { transition: "slide"} );
			$(MAP_ID).gmap('refresh', 1);
		}
		// http://stackoverflow.com/questions/4535888/jquery-text-and-newlines
		function htmlForTextWithEmbeddedNewlines(text) {
		    var htmls = [];
		    var lines = text.split(/\n/);
		    // The temporary <div/> is to perform HTML entity encoding reliably.
		    //
		    // document.createElement() is *much* faster than jQuery('<div/>')
		    // http://stackoverflow.com/questions/268490/
		    //
		    // You don't need jQuery but then you need to struggle with browser
		    // differences in innerText/textContent yourself
		    var tmpDiv = jQuery(document.createElement('div'));
		    for (var i = 0 ; i < lines.length ; i++) {
		        htmls.push(tmpDiv.text(lines[i]).html());
		    }
		    return htmls.join("<br>");
		}
		function openCommentsPage(lid){
			if(!lid) lid = $("#listing_detail").attr("data-parm");
			loadingMsg(true);
			$.get(config.prefix+'data/get_marker_comments.php', {lid: lid}, function(data) {	
				var flag = 0;
				$("#name-comments").text($("#name").text());
				var list = $("#comments-page .list").eq(0);
				var template = $("#comments-page").find(".template");
				list.empty();
				$(data).find('comment').each(function(i) {
					flag = 1;
					var comment_text = $(this).find('comment_text').text();
					var username = $(this).find('username').text();
					//var name = $(this).find('name').text();
					var timestamp = $(this).find('timestamp').text();
					
					var row = template.clone();
					row.removeClass("template");
					row.find(".message").html(htmlForTextWithEmbeddedNewlines(comment_text));
					row.find(".user").text(username);
					row.find(".date").text(timestamp);
					list.append(row);
					//$("#listing_comments_results").append('<p><a href="#" onclick="application.panelManager.openProfileWindow(\'' + username + '\');return(false);">' + username + '</a>:' + name + ' (' + timestamp + ')<br/>' + comment_text + '</p>');									
				
				});
				if(flag == 0) {
					var row = template.clone();
					row.removeClass("template");
					row.find(".message").text("No Comments Added");
					row.find(".user").text("");
					row.find(".date").text("");
					list.append(row);
					//$("#listing_comments_results").html('<p><b>No Comments Added</b><br/><br/>be the first to <a onclick="$(\'#listing_comments\').hide(); $(\'#listing_comments_add\').show(); return(false);" class="" style="" href="#" title="Add Comment">add a comment</a> about ' + that.name + '</p>');
				}
				//$("#listing_comments").show();
				try{list.listview("refresh"); } catch(err){}
				loadingMsg(false);
				$.mobile.changePage( "#comments-page", { transition: "slide"} );
			});				
			
		}
		function deleteMarker(lid){
			if(!lid) lid = $("#listing_detail").attr("data-parm");
			$.post(config.prefix+'data/delete_resource.php', {lid:lid}, function(data) {
				if($(data).find("response_state").attr("success") == 'true') {
					popupMsg("Deleted");
					config.delete_refresh = true;
					window.history.go(-3);
				}
				else
					popupMsg("Error deleting: " + $(data).find("error").attr("message"));
			});
		}
		function openDetailsPage(lid){
			if(!lid) lid = $("#item_summary .details").attr("data-parm");
			
			$("#listing_detail").attr("data-parm", lid);
			$.getJSON(config.prefix + 'data/get_markers.php?format=json&listing_id=' + lid, function(data) {


				if(config.debug) {
					console.log(data.markers[0]);
					console.log("user: " + data.markers[0].user_id);
					console.log("me: " + config.user_id);
				}
				var name = data.markers[0].name;
				if(data.markers[0].edit && data.markers[0].edit == 1) 
					$("#lnkEdit").show();
				else
					$("#lnkEdit").hide();
				if(data.markers[0].delete && data.markers[0].delete == 1) 
					$("#lnkDelete").show();
				else
					$("#lnkDelete").hide();
				if(!name) name = '';
				$('#name').html(name);
				$('#description').html(data.markers[0].desc);
				$('#user').text(data.markers[0].username);
				$('#type').html(data.markers[0].type);
				$('#address').html(data.markers[0].address);
				$('#phone').html(data.markers[0].phone);
				$('#phone').attr('href', 'tel:' + data.markers[0].phone);


				$('#link_code').hide();
				$('#embed_code').hide()

				var escaped_name = name.replace("\"", "\\\"");
				$(".share.href").each(function(i){
					var val = $(this).attr("href");
					val = val.replace("{id}", lid);
					val = val.replace("{name}", escaped_name);
					$(this).attr("href", val);
				});
				$(".share.value").each(function(i){
					var val = $(this).val();
					val = val.replace("{id}", lid);
					val = val.replace("{name}", escaped_name);
					val = val.replace("{zoom}", 14); // to dynamically change this?
					val = val.replace("{lat}", data.markers[0].lat);
					val = val.replace("{lng}", data.markers[0].lng);
					$(this).val(val);
				});

				var value = data.markers[0].www; // value = 9.61 use $("#text").text() if you are not on select box...
				if(value) value = value.replace("http://", ""); // value = 9:61

				$('#www').html(value);
				$('#www').attr('href', 'http://' + value);
				
				$(MAP_SMALL_ID).gmap('clear', 'markers');
				$(MAP_SMALL_ID).gmap('addMarker', { /*id:'m_1',*/ 
						'position': data.markers[0].lat + ',' + data.markers[0].lng, 
						'bounds': true});
				$(MAP_SMALL_ID).gmap('option', 'zoom', 14);
				$("#map_canvas_small").gmap('option', 'center', new google.maps.LatLng( data.markers[0].lat, data.markers[0].lng))
				

				$.mobile.changePage("#listing_detail");

				loadingMsg(false);
				
			});
		}
		
		function openEditPage(lid){
			if(!lid) lid = $("#listing_detail").attr("data-parm");
			$("#edit_detail").attr("data-parm", lid);
			loadingMsg(true);
			$.getJSON(config.prefix + 'data/get_markers.php?format=json&listing_id=' + lid, function(data) {
					
					//console.log(data.markers[0]);
/*
ac_email: ""
ac_on: 0
ac_text: ""
ac_url: ""
address: ""
desc: "Independent network for holistic community activism, sustainability and action research. "
lat: -37.824199676514
lid: 185
lng: 145.04200744629
name: "Borderlands Cooperative"
phone: "123"
rss: ""
subtype: "community space"
subtype_name: "Community Group / Space"
tags: ""
type: "community"
username: "user"
wiki: ""
www: "http://www.borderlands.org.au"

ac_text: ""

lat: -37.824199676514
lid: 185
lng: 145.04200744629

subtype: "community space"
subtype_name: "Community Group / Space"
type: "community"
username: "user"



*/					
					$("#edit-lat").val(data.markers[0].lat);
					$("#edit-lng").val(data.markers[0].lng);
					$("#edit-subtype").val(data.markers[0].subtype);
					$("#edit-type").val(data.markers[0].type);
					
					var name = data.markers[0].name;
					
					$('#edit-category').text(data.markers[0].subtype + "("+ data.markers[0].type +")");
					$('#edit-category').text(data.markers[0].subtype_name);
					
					
					$('#edit-name').val(name);
					$('#edit-description').val(data.markers[0].desc);
					$('#edit-phone').val(data.markers[0].phone);
					$('#edit-address').val(data.markers[0].address);

					var tags = data.markers[0].tags;
					var delim = "type of group:";
					$('#edit-tags_general').val(tags.substr(0,tags.indexOf(delim)));
					$("#edit-tags_type_of_group").val(tags.substr(tags.indexOf(delim)).replace(new RegExp(delim, "g"), ""));
					$("#edit-wiki").val(data.markers[0].wiki);
					$("#edit-www").val(data.markers[0].www);
					$("#edit-rss").val(data.markers[0].rss);
					$('.invite_details').hide();
					if(data.markers[0].ac_on == 1) {
						$('.invite_details').show();
						$("#edit-is_invite").attr("checked", "checked");
					}
					else{
						$('.invite_details').hide();
						$("#edit-is_invite").removeAttr("checked");
					}
					$("#edit-invite_email").val(data.markers[0].ac_email);
					$("#edit-invite_url").val(data.markers[0].ac_url);
					loadingMsg(false);
					$.mobile.changePage( "#edit_detail", { transition: "slide"} );
				});
			
		}
		function openInboxPage(){
			loadingMsg(true);

			// if(this.isLoggedIn()) {
			if(true) {
				//$("#message-edit").hide("fast", function() { 
				//	$("#message-inbox").slideDown("fast");
				//	$("#message-edit").css('display', 'none');
				//});

				var list = $("#inbox-page .list").eq(0);
				var template = $("#inbox-page").find(".template.row");
				list.empty();

				$.post(config.prefix+'data/get_all_conversations.php', {}, function(data) {
					//$("#inbox_conversations").html('');
					$(data).find('conversation').each(function(j){
						var title = $(this).attr("title");
						var conversation_id = $(this).attr("conversation_id");
						var participants = $(this).attr("participants");
						var timestamp = $(this).attr("timestamp");
						var last_message = $(this).attr("last_message");
						var read_flag = '';
						/*
						if($(this).attr("read_flag") == 0) {var read_flag = '<image src="images/unread_star.jpg"/>';}
						var conversations_text = '<div class="listing_left" style="width: 5%; clear: left;">' + read_flag + '<input name="conversation_id" type="checkbox" value="' + conversation_id + '"/></div><div class="listing_left" style="width: 15%;">' + participants + '<br><div class="listing_sub">' + timestamp + '</div></div><div class="listing_main"><a href="#" onclick="application.user.refreshConversation(' + conversation_id + '); return(false);">' + title + ' &nbsp; &nbsp; (view message)</a><div class="listing_sub">' + last_message + '</div></div>';
						$('<div class="listing_div"></div>').html(conversations_text).appendTo("#inbox_conversations");
						*/

						var row = template.clone();
						row.removeClass("template");
						row.find(".message").text(last_message);
						row.find(".user").text(participants);
						row.find(".date").text(timestamp);
						row.find(".url").attr("data-url", conversation_id);
						list.append(row);

					});
					try { list.listview("refresh"); } catch(err){}
					loadingMsg(false);
					$.mobile.changePage( "#inbox-page", { transition: "slide"} );
				});
			}	
		}
		function conversationReply(){
			var conv_id = $("#conversation-page").attr("data-parm");
			var reply = $("#conversation-message").val();
			loadingMsg(true);
			//$("#conversation_reply_button").html('<image id="conversation_reply_wait" src="images/wait_small_white.gif"/>');
			$.post(config.prefix + 'data/add_conversation_message.php', {conversation_id: conv_id, message: reply}, function(data) {
				//that.refreshConversation(conv_id);
				$("#conversation-message").val("");
				openConversationPage(conv_id);
				
			});			
		}
		function commentAdd(lid){
			if(!lid) lid = $("#listing_detail").attr("data-parm");
			var comment_text = $('#comment').val();
			loadingMsg(true);
			$.post(config.prefix + 'data/add_listing_comment.php', {lid:lid, comment_text:comment_text}, function(data){
				$('#comment').val("");
				openCommentsPage(lid);	
			});
			//$("#listing_comments_add").hide();

		}


		$(document).on( "pagebeforechange", function( e, data ) {
			if ( typeof data.toPage === "string" ) {
					var u = $.mobile.path.parseUrl( data.toPage );
					//console.log("to page: " + data.toPage + "|" );
					//console.log(u.hash);
					//console.log(data);
					if(u.hash == "#logout-page"){
						logout();
						e.preventDefault();	
					}
					if ( u.hash.search(/^#conversation-page/) !== -1 && false) {
						//pageSelector = urlObj.hash.replace( /\?.*$/, "" );
						
						//openConversationPage
						//e.preventDefault();
					}
			}
		});
		$(document).on('pageshow', "#listing_detail", function () {
			$(MAP_SMALL_ID).gmap('refresh');
		});
		$(document).on('pageshow', "#add-page", function () {
			$(MAP_ID_add).gmap('refresh');
		});
		$(document).on('pageshow', "#map-page", function () {
			$(MAP_ID).gmap('refresh');
		});		
		function openConversationPage(conv_id){
			loadingMsg(true);

			//$('#inbox_tabs').tabs( 'select' , 0 );
			//if(this.isLoggedIn()) {
			if(true){
				//$("#message-inbox").hide("fast", function() { 
				//	$("#message-edit").slideDown("fast");	
				//});
				var list = $("#conversation-page .list").eq(0);
				var template = $("#conversation-page").find(".template.row");
				list.empty();
				
				$.post(config.prefix+'data/get_conversation.php', {conversation_id: conv_id}, function(data) {
					var title = $(data).find('conversation').attr("title");
					$("#inbox_conversation").html('<div class="listing_div"><div class="listing_left" style="width: 20%;">&nbsp;</div><div class="listing_main"><h3>' + title + '</h3></div>');
					$(data).find('conversation_message').each(function(j){
						var message = $(this).attr("message");
						var user = $(this).attr("user");
						var timestamp = $(this).attr("timestamp");

						var row = template.clone();
						row.removeClass("template");
						row.find(".message").html(htmlForTextWithEmbeddedNewlines(message));
						row.find(".user").text(user);
						row.find(".date").text(timestamp);
						list.append(row);
						//var message_text = '<div class="listing_left" style="width: 20%;">' + user + '<br><div class="listing_sub">' + timestamp + '</div></div><div class="listing_main">' + message + '</div>';
						//$('<div class="listing_div"></div>').html(message_text).appendTo("#inbox_conversation");
					});
					//$("#inbox_conversation").append('<div class="listing_div"><div class="listing_left" style="width: 20%;">&nbsp;</div><div class="listing_main"><b>Reply: </b><br><form class="fg-form" action="#" name="replyform"><textarea name="reply" class="fg-input ui-corner-all" style="width:400px; height:100px; margin-bottom: 0.4em;"></textarea><br><button id="conversation_reply_button" type="button" class="fg-button ui-corner-all ui-state-default" onclick="application.user.conversationReply(' + conv_id + ', this.form.reply.value);">Send</button></form></div></div>');
					try{list.listview("refresh")} catch(err){};
					loadingMsg(false);
					$("#conversation-page").attr("data-parm", conv_id);
					$.mobile.changePage( "#conversation-page", { transition: "slide"} );

				});
			}
		}
		
		// ask server to verify if user is logged in
		function isLoggedIn(){
			$.post(config.prefix+'data/is_logged_in.php', {}, function(data) {
				if($(data).find("response_state").attr("success") == 'true') {
					console.log(data);
					//that.email = $(data).find("user").attr("email");
					//that.full_name = $(data).find("user").attr("full_name");
					//that.username = $(data).find("user").attr("username");

					//$(".show_logged_in").css("display", "block");
					//$(".show_logged_out").css("display", "none");	
					//$("span[id^='your_name']").html(that.full_name);
				}
			});	

		}
		

		function addListing(data){
			$.post(config.prefix + 'data/add_resource.php', 
				{
					title: '',
					desc: '',
					type: '',
					subtype: data.subtype,
					lat: data.lat,
					lng: data.lng,
				}, 
				function(data) {
					// <response><response_state success="true" /><marker lid="8549" /></response>
					if($(data).find("response_state").attr("success") == 'true') {
						config.add_marker = false;
						openEditPage($(data).find("marker").attr("lid"));
					}
					else {
						var msg = $(data).find("error").attr("message"); if(!msg) msg = '';
						if(doOnFailure) {doOnFailure('Failed to save: ' + msg);}
					}
				}
			);			
		}
		// does the actual data transfer to server in order to edit a listing
		function editListing(lid){
			loadingMsg(true);
/*

lid:185
title:Borderlands Cooperative
desc:Independent network for holistic community activism, sustainability and action research. 
type:community
subtype:community space
lat:-37.824199676514
lng:145.04200744629
www:http://www.borderlands.org.au
wiki:
rss:
is_invite:0
invite_email:
invite_url:
address:1
phone:123
tags:,organic,transport,general,type of group:sustainability,type of group:type
*/				
			var data = {};
			data.lid = lid;
			var alltags = '';
			var tags = $("#edit-tags_general").val().split(",");
			for(var i in tags) {
				alltags += ',' + tags[i];
			}
			tags = $("#edit-tags_type_of_group").val().split(",");
			for(var i in tags) {
				alltags += ',' + "type of group".replace(/_/g, ' ') + ':' + tags[i];
			}
			$.post(config.prefix + 'data/update_resource.php', 
				{
					lid: data.lid,
					title: $("#edit-name").val(),
					desc: $("#edit-description").val(),
					type:$("#edit-type").val(),
					subtype:$("#edit-subtype").val(),
					lat:$("#edit-lat").val(),
					lng:$("#edit-lng").val(),
					www:$("#edit-www").val(),
					wiki:$("#edit-wiki").val(),
					rss:$("#edit-rss").val(),
					is_invite:$("#edit-is_invite").val() == "on" ? 1 : 0,
					invite_email:$("#edit-invite_email").val(),
					invite_url:$("#edit-invite_url").val(),
					address:$("#edit-address").val(),
					phone:$("#edit-phone").val(),
					tags:alltags
				}, 
				function(data) {
					if($(data).find("response_state").attr("success") == 'true') {
						//popupMsg("Saved");
						openDetailsPage(lid);
					}
					else {
						var msg = $(data).find("error").attr("message"); if(!msg) msg = '';
						if(doOnFailure) {doOnFailure('Failed to save: ' + msg);}
					}
				}
			);
		}
		
		$(document).ready(function () {
			$("#inbox-page ul.list a").live('click', function(e){
				openConversationPage($(this).attr("data-url"));
			});
			// item details page - 1
			$("a.listing_link").live('click',function(e) {
				loadingMsg(true);
				var lid = $(this).attr("data-parm");
				openDetailsPage(lid);
			});
			// item details page - 0
			

			// edit - 1
			$("#btnEdit").click(function(e){
				e.preventDefault();				
				var lid = $("#edit_detail").attr("data-parm");
				editListing(lid);
			});
			// edit - 0
			
			///////////////////////////////////////////////////////////////////////////
			// main map page - 1
			///////////////////////////////////////////////////////////////////////////

			// search - 1
			$("#lnkLocation").click(function(e){ $("#divLocation").toggle(); });
			$("#btnLocation").click(function(e){
				e.preventDefault();
				findLocationByName($("#txtLocation").val());
			});
			
			$("#btnMyLocation").click(function(e){
				var position;

				position = navigator.geolocation.getCurrentPosition(getCurrentLocation, 
                                         getLocationError, 
                                         { maximumAge: 3000, timeout: 15000, enableHighAccuracy: true });
                   
			});
			
			// search - 0
			
			// filter - 1
			loadCategories();
			$("#lnkSearch").click(function(e){ $("#divSearch").toggle(); });
			$("#btnSearch").click(function(e){
				loadMarkers($(MAP_ID).gmap('option', 'center'));
			});
			// filter - 0

			
			// init map - 1
			// http://code.google.com/p/jquery-ui-map/
			$(MAP_ID).gmap({'center': DEFAULT_LOCATION, 'zoom': DEFAULT_ZOOM, 'mapTypeControl': false}).bind('init', function(evt, map) {
				setTimer(1);

				$(map).click(function(e){
					if(config.debug) console.log(e);
					if(config.add_marker){
						addListing({lat: e.latLng.lat(), lng: e.latLng.lng(), subtype: 'art and culture - ot'});
					}
				});
				// drag map. load search after 1 second after drag ends
				$(map).dragend(function(){
					setTimer();
				}).drag(function(){
					resetTimer();
				}).addEventListener('zoom_changed', function(){
					setTimer();
				});
			});
			$(MAP_ID_add).gmap({'center': DEFAULT_LOCATION, 'zoom': DEFAULT_ZOOM, 'mapTypeControl': false}).bind('init', function(evt, map) {
				$(map).click(function(e){
					addListing({lat: e.latLng.lat(), lng: e.latLng.lng(), subtype: 'art and culture - ot'});
				});
			});			
			// init map - 0
			///////////////////////////////////////////////////////////////////////////
			// main map page - 0
			///////////////////////////////////////////////////////////////////////////
			//openMapPage();
			openSearchPage();
		});


		$(document).on('pagebeforeshow', "#more", function () {
			$("#more-username").text("");
			if(config.user_id){
				$("#more-username").text(config.username);
				$("#more .logged-in").show();
				$("#more .logged-out").hide();
			}
			else{
				$("#more .logged-out").show();
				$("#more .logged-in").hide();
			}
		});		


</script>
</head> 
<body> 

	<div data-role="page" id="search-page" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head" id="headbar">
            <div data-role="navbar" >
                <ul>
                    <li><a href="#search-page" onClick="openSearchPage();" data-mini="true" data-icon="search"></a></li>
                    <li><a href="#map-page" onClick="openMapPage();" data-mini="true" data-icon="globe"></a></li>
                    <li><a href="#add-page" onClick="openAddPage()" data-mini="true" data-icon="plus"></a></li>
                    <li><a href="#more" data-icon="menu" data-mini="true" data-rel="dialog" data-transition="slidedown"></a></li>
                </ul>
            </div><!-- /navbar -->
		</div><!-- /header -->

		<div data-role="content">
			<a href="#" id="lnkLocation" data-role="button" data-theme="b">Specify location </a>
			<div id="divLocation" style="display: none">
				<input id="txtLocation" type="text" value="brunswick west"><input id="btnLocation" type="button" value="Set Location">
				<input id="btnMyLocation" type="button" value="Near Me" data-role="button" data-theme="a">
			</div>

			<a href="#" id="lnkSearch" data-role="button" data-theme="b">Filter Results</a>
			<div id="divSearch" style="display: none">
				<input id="txtSearch" type="text">
				<select id="ddlSearch"></select>
				<input id="btnSearch" type="button" value="Filter">
			</div>

			<ul id='listItems' data-role="listview">
			</ul>
		</div><!-- /content -->
	</div><!-- /page -->

	

   <div data-role="page" id="map-page" data-add-back-btn="true" style="">
		<div data-role="header" data-position="fixed" data-id="head" id="headbar">
            <div data-role="navbar" >
                <ul>
                    <li><a href="#search-page" onClick="openSearchPage();" data-mini="true" data-icon="search"></a></li>
                    <li><a href="#map-page" onClick="openMapPage();" data-mini="true" data-icon="globe"></a></li>
                    <li><a href="#add-page" onClick="openAddPage()" data-mini="true" data-icon="plus"></a></li>
                    <li><a href="#more" data-icon="menu" data-mini="true" data-rel="dialog" data-transition="slidedown"></a></li>
                </ul>
            </div><!-- /navbar -->
		</div><!-- /header -->

        <div data-role="content">
                <div id="map_canvas"></div>
                <div id="item_summary">
					<div data-role="controlgroup"  data-type="horizontal">
						<a href="#listing_detail" onclick="openDetailsPage()" data-role="button" data-icon="info" data-iconpos="left" data-theme="c" data-inline="true" class="details">Item</a>
						<!--
						<a href="index.html" data-role="button" data-icon="arrow-l" data-iconpos="left" data-theme="c" data-inline="true">&nbsp;</a>

						<a href="index.html" data-role="button" data-icon="arrow-r" data-iconpos="left" data-theme="c" data-inline="true">&nbsp;</a>
						-->
					</div>
                </div>
        </div><!-- /content -->
	</div><!-- /page -->
   	<div data-role="page" id="add-page" data-add-back-btn="true" style="">
		<div data-role="header" data-position="fixed" data-id="head" id="headbar">
            <div data-role="navbar" >
                <ul>
                    <li><a href="#search-page" onClick="openSearchPage();" data-mini="true" data-icon="search"></a></li>
                    <li><a href="#map-page" onClick="openMapPage();" data-mini="true" data-icon="globe"></a></li>
                    <li><a href="#add-page" onClick="openAddPage()" data-mini="true" data-icon="plus"></a></li>
                    <li><a href="#more" data-icon="menu" data-mini="true" data-rel="dialog" data-transition="slidedown"></a></li>
                </ul>
            </div><!-- /navbar -->
		</div><!-- /header -->

        <div data-role="content">
                <div id="map_canvas_add"></div>
        </div><!-- /content -->
	</div><!-- /page -->


        
	<div data-role="page" id="listing_detail" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head" id="headbar">
            <div data-role="navbar" >
                <ul>
                    <li><a href="#search-page" onClick="openSearchPage();" data-mini="true" data-icon="search"></a></li>
                    <li><a href="#map-page" onClick="openMapPage();" data-mini="true" data-icon="globe"></a></li>
                    <li><a href="#add-page" onClick="openAddPage()" data-mini="true" data-icon="plus"></a></li>
                    <li><a href="#more" data-icon="menu" data-mini="true" data-rel="dialog" data-transition="slidedown"></a></li>
                </ul>
            </div><!-- /navbar -->
		</div><!-- /header -->

		<div data-role="content">
			<h1 id="name">CommunityFinder</h1>
			<div class="ui-grid-a">
                	<h3 id="type">
						Category
					</h3>
			
                     <div id="map_canvas_small"></div>
			</div>
								<div id="address">
						Street, Suburb, City, Postcode
					</div>
			<div id="phone">
				<a href="tel:0400200700" target="_blank" data-transition="fade">
					Phone
				</a>
			</div>
			<div>
				<a id="www" href="google.com" target="_blank" data-transition="fade">
					Web Site
				</a>
			</div>
			<div id="description">
				Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Donec sed odio dui.
			</div>
			<div>
        	<h5>
				Added by <span id="user"></span>
			</h5>
			
			
			
			

			<a href="#comments-page" onclick="openCommentsPage()" data-role="button" data-icon="arrow-r" data-iconpos="right">Comments</a>
			<a id="lnkEdit" href="#edit-page" onclick="openEditPage()" data-role="button" data-rel="dialog">Edit</a>
			<a id="lnkDelete" href="#delete-page" data-role="button" data-rel="dialog">Delete</a>
			

			<div data-role="collapsible" data-mini="true">
				<h4>Share link</h4>
				<ul>
					<li><img src="images/twitter_share.png" /> <a class="share href" target="_blank" href="http://twitter.com/home?status=Just found {name}. http://communityfinder.net/index.php?lid={id}">Tweet about it on Twitter</a>
					</li>
					<li>
					<img src="images/facebook_share.gif" /> <a class="share href" target="_blank" href="http://www.facebook.com/sharer.php?u=http://communityfinder.net/index.php?lid={id}">Share it on Facebook</a>
					</li>
					<li><img src="images/link_share.jpg" /> <a href="#" onclick="$('#link_code').toggle('normal');$('#embed_code').hide('slow'); return(false);">Email / Link to this Listing</a></p>	
						<p id="link_code" style="display:none;">Cut and Paste the following code to link to this listing: <br/>
					<input type="text" class="share value" value="http://communityfinder.net/index.php?zoom={zoom}&lat={lat}&lng={lng}&lid={id}" /></p>	
					</li>	
				</ul>
			</div>


				<!-- 
					<a target="_blank" href="http://twitter.com/home?status=Just found St Johns Op Shop - Brunswick West. http://victoriacommunity.org/index.php?lid=7519">Tweet about it on Twitter</a>
						<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://google.com" data-text="test">Tweet</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>	



New Sharing
	Twitter: https://twitter.com/about/resources/buttons#tweet
	Facebook: requires app API key...
		http://developers.facebook.com/docs/reference/plugins/send/
		http://developers.facebook.com/docs/reference/plugins/like/
old code
	var text_share = '<div class="info_window" style="height: 130px; overflow:hide;">'; 
	text_share += '<p><img style="margin-bottom: -4px;" src="images/twitter_share.png" /> <a target="_blank" href="http://twitter.com/home?status=Just found ' + this.name + '. http://victoriacommunity.org/index.php?lid=' + this.lid + '">Tweet about it on Twitter</a></p>';
	text_share += '<p><img style="margin-bottom: -4px;" src="images/facebook_share.gif" /> <a target="_blank" href="http://www.facebook.com/sharer.php?u=http://victoriamycommunity.org/index.php?lid=' + this.lid + '">Share it on Facebook</a></p>';
	text_share += '<p><img style="margin-bottom: -4px;" src="images/link_share.jpg" /> <a href="#" onclick="$(\'#link_code\').toggle(\'normal\');$(\'#embed_code\').hide(\'slow\'); return(false);">Email / Link to this Listing</a></p>';	
	text_share += '<p id="link_code" style="display:none;">Cut and Paste the following code to link to this linsting: <br/>';
	text_share += '<input type="text" style="width: 280px;" value="http://www.victoriamycommunity.org/index.php?zoom=' + map.getZoom() + '&lat=' + lat_lng.lat() + '&lng=' + lat_lng.lng() + '&lid=' + this.lid + '" /></p>';		 

	text_share += '<p><img style="margin-bottom: -4px;" src="images/embed_share.jpg" /> <a href="#" onclick="$(\'#embed_code\').toggle(\'normal\');$(\'#link_code\').hide(\'slow\'); return(false);">Embed this Listing / Map into your website</a></p>';	
	text_share += '<p id="embed_code" style="display:none;">Cut and Paste the following code to embed this linsting: <br/>';
	text_share += '<input type="text" style="width: 280px;" value="<iframe src=&quot;http://www.victoriamycommunity.org/index.php?zoom=' + map.getZoom() + '&lat=' + lat_lng.lat() + '&lng=' 
		+ lat_lng.lng() + '&lid=' + this.lid + '&quot; style=&quot;width: ' + width + 'px; height:' + height + 'px; border:none;&quot;></iframe>" /></p>';		 
	text_share += '</div>';


<div class="info_window" style="height: 130px; overflow:hide;">
	<p><img style="margin-bottom: -4px;" src="images/twitter_share.png" /> <a target="_blank" href="http://twitter.com/home?status=Just found ' + this.name + '. http://victoriacommunity.org/index.php?lid=' + this.lid + '">Tweet about it on Twitter</a></p>
	<p><img style="margin-bottom: -4px;" src="images/facebook_share.gif" /> <a target="_blank" href="http://www.facebook.com/sharer.php?u=http://victoriamycommunity.org/index.php?lid=' + this.lid + '">Share it on Facebook</a></p>
	<p><img style="margin-bottom: -4px;" src="images/link_share.jpg" /> <a href="#" onclick="$(\'#link_code\').toggle(\'normal\');$(\'#embed_code\').hide(\'slow\'); return(false);">Email / Link to this Listing</a></p>	
	<p id="link_code" style="display:none;">Cut and Paste the following code to link to this linsting: <br/>
	<input type="text" style="width: 280px;" value="http://www.victoriamycommunity.org/index.php?zoom=' + map.getZoom() + '&lat=' + lat_lng.lat() + '&lng=' + lat_lng.lng() + '&lid=' + this.lid + '" /></p>		 

	<p><img style="margin-bottom: -4px;" src="images/embed_share.jpg" /> <a href="#" onclick="$(\'#embed_code\').toggle(\'normal\');$(\'#link_code\').hide(\'slow\'); return(false);">Embed this Listing / Map into your website</a></p>	
	<p id="embed_code" style="display:none;">Cut and Paste the following code to embed this linsting: <br/>
	<input type="text" style="width: 280px;" value="<iframe src=&quot;http://www.victoriamycommunity.org/index.php?zoom=' + map.getZoom() + '&lat=' + lat_lng.lat() + '&lng=' 
		+ lat_lng.lng() + '&lid=' + this.lid + '&quot; style=&quot;width: ' + width + 'px; height:' + height + 'px; border:none;&quot;></iframe>" /></p>		 
	</div>

				-->
			</div>
		</div>
	</div>
        <!-- /page listing_detail -->


	<div data-role="page" id="comments-page" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head">
			<h1>Comments</h1>
		</div>
		<div data-role="content">
			<h2 id="name-comments"></h2>
			<ul class="list" data-role="listview" data-theme="d" data-divider-theme="d">
		        <li data-role="list-divider">You need to select a page:</li> 
			</ul>
			<ul data-role="listview" data-theme="d" data-divider-theme="d">
				<li>
					<form>
						<label for="comment">Comment:</label>
						<textarea name="comment" id="comment"></textarea>
						<input id="comment_add" type="button" value="Send" onclick="commentAdd()">
					</form>
				</li>
			</ul>
		</div><!-- /content -->

		<ul>
			<li class='template'>
				<h3 class="user">User</h3>
				<p class="message">Message left by user</p>
				<p class="ui-li-aside"><strong class='date'>The Time</strong></p>
			</li>
		</ul>


	</div><!-- /page -->


<div id="more" data-role="page" class="dialog-actionsheet">
		<div data-role="content" data-theme="a">
			<h1 class="logged-in" id="more-username"></h1>
	        <a class="logged-out" href="#login-page" data-theme="b" data-role="button" data-rel="dialog" data-transition="slidedown" >Login</a>
	        <a class="logged-out" href="#register-page" data-theme="b" data-role="button" data-rel="dialog" data-transition="slidedown" >Register</a>
	        <a class="logged-in" href="#" onClick="openInboxPage()" data-theme="b" data-role="button">Inbox</a>
	        <a class="logged-in" href="#" onClick="loadMyMarkers()"data-theme="b" data-role="button">Your Listings</a>
	        <br class="logged-in" >
	        <a class="logged-in" href="#logout-page" data-theme="b" data-role="button" data-rel="dialog" >Logout</a>
	        <br>
			<a href="#" data-role="button" data-rel="back" data-theme="a">Cancel</a>    
		</div>
	</div>

	<div data-role="page" id="edit_detail" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head" id="headbar">
			<h1>CommunityFinder</h1>
			<a href="#toolbarPanel" data-rel="popup" data-transition="slide" data-position-to="window" data-role="button" class="ui-btn-right" data-icon="arrow-d">Menu</a>
			<div data-role="popup" id="toolbarPanel" data-corners="false" data-theme="none" data-shadow="false" data-tolerance="0,0" data-position-to="#">
            <div data-role="navbar" >
                <ul>
                    <li><a href="#search-page" onClick="openSearchPage();" data-mini="true" data-icon="search"></a></li>
                    <li><a href="#map-page" onClick="openMapPage();" data-mini="true" data-icon="globe"></a></li>
                    <li><a href="#add-page" onClick="openAddPage()" data-mini="true" data-icon="plus"></a></li>
                    <li><a href="#more" data-icon="menu" data-mini="true" data-rel="dialog" data-transition="slidedown"></a></li>
                </ul>
            </div><!-- /navbar -->
		</div>
		</div><!-- /header -->
		<div data-role="content">
				<form>
					Category: <b id='edit-category'></b>

					<input id='edit-lat' type="hidden" >
					<input id='edit-lng' type="hidden" >
					<div>
						<span title="" style="float: right;" class="tag_link ui-icon ui-icon-info "></span>
						<label for="name">Title: </label>
						<input id='edit-name' name="name" value="" class="fg-input ui-corner-all">
					</div>
					<div>
						<span title="" class="tag_link ui-icon ui-icon-info " style="float: right;"></span>
						<label for="description">Description: </label>
						<textarea id='edit-description' name="description" cols="35" rows="2" class="fg-input ui-corner-all" ></textarea>
					</div>
					<div>
						<label for="phone">Phone: </label>
						<input id='edit-phone' name="phone" value="" class="fg-input ui-corner-all">
					</div>
					<div>
						<label for="address">Address: </label>
						<textarea id='edit-edit-address' name="address" cols="35" rows="2" class="fg-input ui-corner-all" ></textarea>
					</div>
					<div>
						<label for="tags_general">Tags (general): </label>
						<input name="tags_general" id="edit-tags_general" value="" class="fg-input ui-corner-all ui-autocomplete-input"  autocomplete="off">
					</div>
					<div>
						<label for="tags_type_of_group">Tags (type of group): </label>
						<input name="tags_type_of_group" id="edit-tags_type_of_group" value="" class="fg-input ui-corner-all ui-autocomplete-input"  autocomplete="off">
						ie. environment, social justice etc
					</div>
					<div>
						<span title="Links listing to associated Wikipedia page, just start typing and we'll suggest exisiting pages on wikipedia" class="tag_link ui-icon ui-icon-info " style="float: right;"></span>
						<label for="wiki">Wikipedia Page:</label>
						<input id="edit-wiki" name="wiki" value="" class="fg-input ui-corner-all ui-autocomplete-input"  autocomplete="off">
					</div>
					<div>
						<span title="Links listing to an associated Web Site" class="tag_link ui-icon ui-icon-info " style="float: right;"></span>
						<label for="www">WWW (ie http://..): </label>
						<input id="edit-www" name="www" value="" class="fg-input ui-corner-all" >
					</div>
					<div>
						<label for="rss">RSS: (ie http://..) </label>
						<input id="edit-rss" name="rss" value="" class="fg-input ui-corner-all" >
					</div>
					
					<div data-role="fieldcontain">
						<input onclick="$('.invite_details').toggle();" type="checkbox" id="edit-is_invite" name="is_invite" class="fg-input ui-corner-all">
						<label for="is_invite">Customise 'contact us' link</label>
					</div>
					<div class="invite_details" style="display: none;">
						Instead of using the built in inbox system, provide either an email address, or 'contact us' form url to customise the 'contact user' link on this listing.
					</div>	
					<div class="invite_details" style="display: none;">
						<label for="invite_email">Email:</label>
						<input id="edit-invite_email" name="invite_email" value="" class="fg-input ui-corner-all"> or 
					</div>	
					<div class="invite_details" style="display: none;">
						<label for="invite_url">Contact URL:</label>
						<input id="edit-invite_url" name="invite_url" value="" class="fg-input ui-corner-all">
					</div>	

					<input type="button" value="Save" id="btnEdit">
				</form>
				
			<div>
			</div>
		</div>
	</div>

	<div data-role="dialog" id="delete-page">
		<div data-role="header">
			<h1>Delete Marker</h1>
		</div>

		<div data-role="content">
			<h3>Delete Marker?</h3>
			<div data-inline="true">
			    <a href="#" data-role="button" data-rel="back">Cancel</a>
			    <a href="#" data-role="button" data-theme="b" onclick="deleteMarker(); return false;">Delete</a>
			</div>
		</div>
	</div>
	<!-- /page edit_details-->


	<div data-role="page" id="inbox-page" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head">
			<h1>Inbox</h1>
		</div>
		<div data-role="content">
			<ul class="list" data-role="listview" data-theme="d" data-divider-theme="d">
			</ul>
		</div><!-- /content -->
		<ul>
			<li class='template header'><span class='content'>The Date</span><span class="ui-li-count count">number of messages</span></li>
			<li class='template row'>
				<a href="#conversation-page" data-url="" class="url">
					<h3 class="user">User</h3>
					<p class="message">Message left by user</p>
					<p class="ui-li-aside"><strong class='date'>The Time</strong></p>
				</a>
			</li>
		</ul>
	</div><!-- /page -->
	<div data-role="page" id="conversation-page" data-add-back-btn="true">
		<div data-role="header" data-position="fixed" data-id="head">
			<h1>Conversation</h1>
		</div>
		<div data-role="content">
			<ul class="list" data-role="listview" data-theme="d" data-divider-theme="d">
			</ul>
			<ul data-role="listview" data-theme="d" data-divider-theme="d">
				<li>
					<form>
						<label for="conversation-message">Reply:</label>
						<textarea name="conversation-message" id="conversation-message"></textarea>
						<input id="conversation_reply_button" type="button" value="Send" onclick="conversationReply()">
					</form>
				</li>
			</ul>
			<ul>
				<li class='template header' data-role="list-divider"><span class='content'>Conversation Title</span><span class="ui-li-count count">number of messages</span></li>
				<li class='template row'>
					<h3 class="user">User</h3>
					<p class="message">Message left by user</p>
					<p class="ui-li-aside"><strong class='date'>The Time</strong></p>
				</li>
			</ul>
		</div><!-- /content -->
	</div><!-- /page -->	
	
	<div id="popup" data-role="dialog">
	    <div data-role="header" data-theme="d">
	        <h1>Info</h1>
	    </div>
	    <div data-role="content" data-theme="c">
	        <div class='content'></div>
	        <a data-role="button" data-rel="back">Ok</a>
	    </div>
	</div>
	<div data-role="dialog" id="login-page" data-add-back-btn="true">
		<div data-role="header">
			<h1>Login</h1>
		</div>
		<div data-role="content">
			<form>
				<div data-role="fieldcontain">
					<label for="login-user">Username / Email:</label>
		    		<input type="text" name="login-user" id="login-user" value=""  />
				</div>	
				<div data-role="fieldcontain">
					<label for="login-pass">Password:</label>
		    		<input type="password" name="login-pass" id="login-pass" value=""  />
				</div>	
				<input type="submit" value="Login" onClick="login(); return false;">
			</form>

		</div>
	</div>
	<div data-role="page" id="register-page" data-add-back-btn="true">
		<div data-role="header">
			<h1>Register</h1>
		</div>
		<div data-role="content">
			<form>
				<div data-role="fieldcontain">
					<label for="register-email">Email:</label>
		    		<input type="text" name="register-email" id="register-email" value=""  />
				</div>	
				<div data-role="fieldcontain">
					<label for="register-pass">Password:</label>
		    		<input type="password" name="register-pass" id="register-pass" value=""  />
				</div>	
				<div data-role="fieldcontain">
					<label for="register-full-name">Full name:</label>
		    		<input type="text" name="register-full-name" id="register-full-name" value=""  />
				</div>	
				<div data-role="fieldcontain">
					<label for="register-user">Username:</label>
		    		<input type="text" name="register-user" id="register-user" value=""  />
				</div>	
				<input type="submit" value="Register" onClick="register(); return false;">
			</form>
		</div>
	</div>
	
</body>
</html>
